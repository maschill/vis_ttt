{% extends "layout.html" %}

{% block body %}

<h1>Home - Analytics - Visualization - Also: Best UX by far!</h1>

<div class="border border-dark p-5 my-5 col-md-12 bg-light">
	<button type="button" class="btn border border-dark btn-default float-sm-right" id="data_request_btn">Request Data</button>

	<h3 class="float-sm-left"> Status:  </h3> <h3 class="float-sm-left pl-5"> <div  id="dyn_block">waiting for request</div></h3>
	<br>
	<br><br><br>
	<label for="mission0">Mission Name:</label>
	<input type="text", value = "", id="mission0", class="form-control float-sm-right col-md-6">

	<br><br>
	<label for="starttimeMin">Select Starttime</label>
	<input type="text" id="starttimeMin" value="1900-01-01", class="form_datetime form-control col-md-4 float-sm-right" />
	<input type="text" id="starttimeMax" value="2020-12-24", class="form_datetime form-control col-md-4 float-sm-right" />

	<br><br>
	<div>
		<label for="latitude_longitude">Laditude, Longitude (use "_" instead of floating point)</label>
		<input type="text" id="latitude_longitude" value="", class="form_datetime form-control col-md-4 float-sm-right" />
	</div>
	<br><br>
	<div>
		<label for="measure_variable">Variable</label>
		<input type="text" id="measure_variable" value="percentageofpote1", class="form_datetime form-control col-md-4 float-sm-right" />
	</div>
</div>


<div class="border border-dark p-5 my-5 col-md-12 bg-light">
	<h3 class="text-center">Measured Variables</h3>
	<div id="chart" style="overflow-y:scroll; overflow-x:hidden; height:300px;"></div>
	<div id="chart2" style="overflow:hidden;"></div>

</div>

<div class="col-md-12 bg-light border border-dark p-5">
<<<<<<< HEAD
	<div class="m-5 py-5" id="map" style="min-width: 400px; min-height: 400px"></div>
=======
	<div class="p-5" id="map" style="width:1000; height:800"></div>
>>>>>>> 2f09e7d886cdc6d15e7dceee3cf8a3af5cf645d0

	<!-- <div class="py-5 m-5 col-md-12 float-sm-right"> -->
		<div class="col-md-6 col-sm-12 float-sm-right">
			<button type="button" class="btn border border-dark btn-default float-sm-right px-4" id="data_show_toggle">Show Data</button>
			<a class="float-sm-right px-4" href="/csv/"><button type="button" class="btn border border-dark btn-default" id="data_download">Download Data</button></a>
		</div>
	<!-- </div>	 -->


	<div class="pb-1"></div><div class="col-sm-1 float-sm-left pb-2"> Slider:</div> 
	<div class="px-3 col-sm-1 float-sm-left pb-2" id="slider_val">50</div>
	<div id="slider-range" class="col-md-4 float-sm-right px-3"></div>

</div>


<table id="testTable"  class="table table-striped my-5">
	<thead>
		<tr class="thead-dark">
			<th>Year</th>
			<th>Lat</th>
			<th>Lon</th>
			<th id="valcol">percentageofpote1</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
	</tbody>
</table>



<script>
    var data = {{ d3data | safe }}

    data.sort(function(x,y){
        return d3.ascending(Math.abs(x.std_deviation / x.avg), Math.abs(y.std_deviation / y.avg))})

    var docnum = {{ docnum | safe }}
    var gap = 10

        var margin = {top: 07, right: 20, bottom: 00, left: 150},
			width = 960 - margin.left - margin.right,
			height = 1305 - margin.top - margin.bottom;

		var formatPercent = d3.format(".0%");

		var xR = d3.scale.log()
		    .range([0, width/2-gap/2]);

		var xL = d3.scale.linear()
		    .range([width/2-gap/2, 0]);

		var y = d3.scale.ordinal()
		    .rangeRoundBands([height, 0], .3);

		var xRAxis = d3.svg.axis()
			.scale(xR)
			.ticks(3)
			.orient("top")
			.tickSize(3)

		var xLAxis = d3.svg.axis()
			.scale(xL)
			.ticks(3)
			.orient("top")
			.tickSize(3)
			//.tickFormat(function(d) { return Math.round(Math.log(d)); });

		var yAxis = d3.svg.axis()
		    .scale(y)
		    .tickSize(3)
		    .orient("left");

		var tipL = d3.tip()
		  .attr('class', 'd3-tip')
		  .offset([0, 0])
		  .html(function(d) {
			return d.fname + ": " + d3.format(".0f")(Math.round(100 * d.count / docnum));
		  })

		var tipR = d3.tip()
		  .attr('class', 'd3-tip')
		  .offset([0, 0])
		  .html(function(d) {
			return d.fname + ": " + d3.format(".2f")(Math.abs(d.std_deviation / d.avg));
		  })

		var svg = d3.select("#chart").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		  .append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		svg.call(tipL);
		svg.call(tipR);

		data.forEach(function(d,i){
			y.domain(data.map(function(d) { return d.fname; }));
			xR.domain([0.1, d3.max(data, function(d) { return Math.abs(d.std_deviation / d.avg); })]);
			xL.domain([0, d3.max(data, function(d) { return (100 * d.count / docnum); })]);
		});

	  svg.append("g")
		  .attr("class", "axis--y")
		  //.attr("transform", "translate(" + width + ",0)")
		  .call(yAxis)
		.append("text")
		  .attr("class", "text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 3)
		  .attr("dy", "0.2em")
		  .attr("text-anchor", "end");

		svg.selectAll("rectright")
			.data(data).enter()
				.append("rect")
				  .attr("class", "bar")
				  .attr("y", function(d) { return y(d.fname); })
				  .attr("height", y.rangeBand())
				  .attr("width", function(d) { return xR(Math.abs(d.std_deviation / d.avg)); })
				  .attr("x", width/2 + gap/2) //function(d) { return x(d.std_deviation / d.avg); })
				  .on('mouseover', tipR.show)
				  .on('mouseout', tipR.hide)
				  .on("click", function(d) {$("#measure_variable").val(d.fname); })

		svg.selectAll("rectleft")
			.data(data).enter()
				.append("rect")
				  .attr("class", "bar")
				  .attr("y", function(d) { return y(d.fname); })
				  .attr("height", y.rangeBand())
				  .attr("width", function(d) { return (xL(0) - xL(98 * d.count / docnum)); })
				  .attr("x", function(d) { return (width/2-gap/2)-(xL(0) - xL(98 * d.count/docnum));})
				  //function(d) { return x(d.std_deviation / d.avg); })
				  .on('mouseover', tipL.show)
				  .on('mouseout', tipL.hide)
				  .on("click", function(d) {$("#measure_variable").val(d.fname); })
				  //.on("click", function(d) {console.log("event = ", d.fname)})

		svg.select("yaxis")
			.style("font-size","15px");
</script>

<script>
    var data = {{ d3data | safe }}

    data.sort(function(x,y){
        return d3.ascending(Math.abs(x.std_deviation / x.avg), Math.abs(y.std_deviation / y.avg))})

    var docnum = {{ docnum | safe }}
    var gap = 10

        var margin = {top: 05, right: 20, bottom: 45, left: 150},
			width = 960 - margin.left - margin.right,
			height = 70 - margin.top - margin.bottom;

		var formatPercent = d3.format(".0%");

		var xR = d3.scale.log()
		    .range([width/2+gap/2, width]);

		var xL = d3.scale.linear()
		    .range([width/2-gap/2, 0]);

		var xRAxis = d3.svg.axis()
			.scale(xR)
			.ticks(3)
			.orient("top")
			.tickSize(3)
			//.tickFormat(function(d) { return Math.round(Math.log(d)); });

		var xLAxis = d3.svg.axis()
			.scale(xL)
			.ticks(3)
			.orient("top")
			.tickSize(3)
			.tickPadding(-20)
			.tickFormat(function(d) { return Math.round(d); });

		var svg = d3.select("#chart2").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		  .append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		data.forEach(function(d,i){
			y.domain(data.map(function(d) { return d.fname; }));
			xR.domain([0.1, d3.max(data, function(d) { return Math.abs(d.std_deviation / d.avg); })]);
			xL.domain([0, d3.max(data, function(d) { return (100 * d.count / docnum); })]);
		});

		svg.append("text")
			.attr("class", "x-label")
			.attr("text-anchor", "middle")
			.attr("x", width/2+(width/2-gap)/2)
			.attr("y", height+40)
			.text("Coefficient of variation");

		svg.append("text")
			.attr("class", "x-label")
			.attr("text-anchor", "middle")
			.attr("x", (width/2-gap)/2)
			.attr("y", height+40)
			.text("Relative frequency of variable");

		svg.append("g")
		  .attr("class", "x axis")
		  .attr("transform", "translate(0," + height + ")")
		  .call(xRAxis) //.ticks(10, "%"))

	 	svg.append("g")
		  .attr("class", "x axis")
		  .attr("transform", "translate(0," + height + ")")
		  .call(xLAxis) //.ticks(10,"%"))

		svg.select("xaxis")
			.style("font-size","15px");

</script>

<script type="text/javascript">
var placesByYear = null;
var places = null;
var ply = null;

function ajaxCallBack(data){
	console.log(data)
	places = Object.values(data.data);
	placesByYear = d3.nest()
	.key(function(d){ return d.year;})
	.entries(places);
	//updatescatter(data.minmax.miny)
	ply = placesByYear.find(d => d.key == data.minmax.miny).values;

}

function grp(data){
	placesByYear = d3.nest()
	.key(function(d){ return d.year;})
	.entries(data.data);
	console.log(placesByYear);
}

var tip = d3.tip()
		.attr('class', 'd3-tip')
		.offset([250, 0])
		.style("left", "300px")
		.style("top", "400px")
		.html(function(d) {
			return d.val;
		})

	svg.call(tip);

<<<<<<< HEAD
	var width = 650,
		height = 650;
=======
	var width = 800,
		height = 600;
>>>>>>> 2f09e7d886cdc6d15e7dceee3cf8a3af5cf645d0
	var color= d3.scale.ordinal()
		.domain([1,2,3,4,5,6,7,8,9])
		.range(colorbrewer.Oranges[9]);

	var projection = d3.geo.mercator().scale(90).translate([width/2+width/12,height/2]);
	var path = d3.geo.path()
		.projection(projection);

	// Define color map
	var mycolors = ["red", "black", "green"]
	var mycolorsRange = d3.range(0,1,(1/(mycolors.length-1)));
		mycolorsRange.push(1)

	var colorScale = d3.scale.linear()
		.range(mycolors)
		.domain(mycolorsRange)
		.interpolate(d3.interpolateHcl);

	var colorInterpolate = d3.scale.linear()
		.range([0,1])

	var defs = svg.append("defs")
		defs.append("linearGradient")
			.attr("id", "linear-gradient")
			.attr("x1", "0%")
			.attr("y1", "0%")
			.attr("x2", "0%")
			.attr("y2", "100%")
			.selectAll("stop")
			.data(mycolors)
			.enter().append("stop")
			.attr("offset",  function(d,i) {return i/(mycolors.length-1);})
			.attr("stop-color", function(d){return d;})
	
	var svg;


function d3worldmap(data){

	ajaxCallBack(data);
	
	svg = d3.select("#map").append("svg")
<<<<<<< HEAD
		.attr("viewBox", "0 0 "+width+" "+height)
		//.attr("preserveAspectRatio", "xMidYMid meet");
=======
		.attr("viewBox", "0 0 600 600")
		.attr("preserveAspectRatio", "xMidYMid meet");
>>>>>>> 2f09e7d886cdc6d15e7dceee3cf8a3af5cf645d0

	//append legendS
	var legend = svg.append("g")
		.attr("class", "legendWrapper")
		.attr("transform", "translate("+(width) + "," + (height))

	var marginscaletop = 40
	legend.append("rect")
		.attr("x", 50)
		.attr("y", marginscaletop)
		.attr("width", 10)
		.attr("height", height-2*marginscaletop)
		.style("fill", "url(#linear-gradient)")

	// Set axis
	var yScale = d3.scale.linear()
		.range([marginscaletop, height-marginscaletop])
		//.domain([0,100])
		.nice()

	var yAxis = d3.svg.axis()
		.ticks(5)
		.tickFormat(d3.format(""))
		.scale(yScale)
		.orient("right")

	svg.append("g")
		.attr("class", "axis")
		.attr("transform","translate("+ 0 +","+ 0 +")")
		.call(yAxis);

	places.forEach(function(i,d){
		colorInterpolate.domain([d3.min(places, function(d) { return d.val; }),
			d3.max(places, function(d) { return d.val; })]);
		yScale.domain([d3.min(places, function(d) { return d.val; }),
			d3.max(places, function(d) { return d.val; })]);
	});

	d3.json("https://s3-us-west-2.amazonaws.com/vida-public/geo/world-topo-min.json", function(error, swiss) {
	if (error) throw error;

	var cantons = topojson.feature(swiss, swiss.objects.countries);

			//svg.call(tip);
		var group=svg.selectAll("g")
			.data(cantons.features)
			.enter()
			.append("g");
			//.on('mouseover', tip.show)
				//.on('mouseout', tip.hide)

	var pins = 	svg.selectAll("circle").data(ply);

	pins.exit().remove();

	pins.enter()
		.append("circle")
		// .append("class", ".pin")
		.attr("r", 5)
		.attr("transform", function(d) {
			return "translate(" + projection([
						d.scene_lon,
						d.scene_lat
						]) + ")";
						})
		.style('fill', function(d){return colorScale(colorInterpolate(d.val))})
		//.on('mouseover', tip.show)
		//.on('mouseout', tip.hide);

		.on("mouseover", function(d) {
		  tip.show(d)
		  d3.select(this).attr("r", 10)
		})
		.on("mouseout", function(d) {
		  tip.hide(d)
		  d3.select(this).attr("r", 5)
		});

	pins.transition().duration(1);
	//var projection = d3.geo.mercator().scale(1200).translate([-600,700]);
	var path= d3.geo.path().projection(projection);

	var areas= group.append("path")
		.attr("d", path)
		.attr("class", "area")
		.attr("fill","darkblue");

	});
}

function updatescatter(year) {
	var pins = svg.selectAll("circle").data(ply);

	ply = placesByYear.find(d => d.key == year).values;

	console.log(pins.enter());
	console.log(pins.exit());
	pins.exit().remove();

	pins.enter()
	.append("circle")//, ".pin")
	.attr("r", 5)
	.attr("transform", function(d) {
		return "translate(" + projection([
					d.scene_lon,
					d.scene_lat
					]) + ")";
					})
	.style('fill', function(d){return colorScale(colorInterpolate(d.val))})
	.on('mouseover', tip.show)
	.on('mouseout', tip.hide); 

	pins.transition().duration(10);

	console.log('jaa', function(d) {console.log("event = ", d)});
};

$(function() {

$( "#slider-range" ).slider({
	min: 0,
	max: 1000,
	slide: function( event, ui){
		$("#slider_val").html(ui.value);
		updatescatter(ui.value);

	}
});

$( "#testTable" ).hide();
$( "#data_show_toggle" ).click(function() {
	 $( "#testTable" ).toggle();
});

$("#data_request_btn").click(function(){
	$("#dyn_block").html("Working");
	$.ajax({
		// it needs to be property:value NOT property=value
		// Post request because we need to send filter values
		// Mock Request works with both POST and GET
		type:'GET',
		url:"/api/filter?mission0=" + $("#mission0").val()
					+   "&starttimeMin=" + $("#starttimeMin").val()
					+   "&starttimeMax=" + $("#starttimeMax").val()
					+   "&latitude_longitude=" + $("#latitude_longitude").val()
					+   "&measure_variable=" + $("#measure_variable").val(),
		data:{},
		contentType: 'application/json;charset=UTF-8',
		cache: false,
		success: function (data) {
			$("#map").html("");
			//ajaxCallBack(data);
			console.log('sucessful answer received!');
			$("#dyn_block").html("Data delivered.");
			$("#valcol").html($("#measure_variable").val());
			$("#testTable tbody").empty();
			$('#data_show_toggle')[0].scrollIntoView(true);
			$.each(data.data, function(i,item){
				$("#testTable tbody").append(
					"<tr>"
						+ "<td>" + item.year + "</td>"
						+ "<td>" + item.scene_lat + "</td>"
						+ "<td>" + item.scene_lon + "</td>"
						+ "<td>" + item.val + "</td>"
					+ "</tr>"
				);
			});
			$( "#slider-range" ).slider( "option", "min", data.minmax.miny );			
			$( "#slider-range" ).slider( "option", "value", data.minmax.miny );
			$( "#slider-range" ).slider( "option", "max", data.minmax.maxy );
			d3worldmap(data);
		},
		error: function() {
			$("#dyn_block").html("Error. Pleas Try again!");
		},
	});
});



var dateFormat = "yyyy-mm-dd",
	from = $( "#starttimeMin" )
        .datepicker({
          defaultDate: "+1w",
          changeMonth: true,
          numberOfMonths: 1,
		  dateFormat : "yy-mm-dd"
        })
        .on( "change", function() {
          to.datepicker( "option", "minDate", getDate( this ) );
        }),
    to = $( "#starttimeMax" ).datepicker({
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 1,
		dateFormat : "yy-mm-dd"
      })
      .on( "change", function() {
        from.datepicker( "option", "maxDate", getDate( this ) );
});
function getDate( element ) {
      var date;
      try {
        date = $.datepicker.parseDate( dateFormat, element.value );
      } catch( error ) {
        date = null;
      }
 
      return date;
}

});

</script>

{% endblock %}
