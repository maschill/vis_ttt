{% extends "layout.html" %}

{% block body %}
<h1>Home - Analytics - Visualization</h1>
<h1>Also: Best UX by far!</h1>
<p>Home - Analytics - Visualization</p>

<div id="chart">chart here</div>

<script>
    var data = {{ d3data | safe }}

    data.sort(function(x,y){
        return d3.ascending(Math.abs(x.std_deviation / x.avg), Math.abs(y.std_deviation / y.avg))})

    var docnum = {{ docnum | safe }}
    var gap = 10

        var margin = {top: 60, right: 20, bottom: 80, left: 200},
			width = 960 - margin.left - margin.right,
			height = 1500 - margin.top - margin.bottom;

		var formatPercent = d3.format(".0%");

		var xR = d3.scale.log()
		    .range([0, width/2-gap/2]);

		var xL = d3.scale.linear()
		    .range([width/2-gap/2, 0]);

		var y = d3.scale.ordinal()
		    .rangeRoundBands([height, 0], .3);

		var xRAxis = d3.svg.axis()
			.scale(xR)
			.ticks(3)
			.orient("top")
			.tickSize(3)


		var xLAxis = d3.svg.axis()
			.scale(xL)
			.ticks(3)
			.orient("top")
			.tickSize(3)
			//.tickFormat(function(d) { return Math.round(Math.log(d)); });

		var yAxis = d3.svg.axis()
		    .scale(y)
		    .tickSize(3)
		    .orient("left");

		var tipL = d3.tip()
		  .attr('class', 'd3-tip')
		  .offset([0, 0])
		  .html(function(d) {
			return d.fname + ": " + d3.format(".0f")(Math.round(100 * d.count / docnum));
		  })

		var tipR = d3.tip()
		  .attr('class', 'd3-tip')
		  .offset([0, 0])
		  .html(function(d) {
			return d.fname + ": " + d3.format(".2f")(Math.abs(d.std_deviation / d.avg));
		  })

		var svg = d3.select("#chart").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		  .append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		svg.call(tipL);
		svg.call(tipR);

		data.forEach(function(d,i){
			y.domain(data.map(function(d) { return d.fname; }));
			xR.domain([0.1, d3.max(data, function(d) { return Math.abs(d.std_deviation / d.avg); })]);
			xL.domain([0, d3.max(data, function(d) { return (100 * d.count / docnum); })]);
		});



	 svg.append("g")
		  .attr("class", "x axis")
		  .attr("transform", "translate(" + (width+gap)/2 + "," + height + ")")
		  .call(xRAxis) //.ticks(10, "%"))

	 svg.append("g")
		  .attr("class", "x axis")
		  .attr("transform", "translate(0," + height + ")")
		  .call(xLAxis) //.ticks(10,"%"))

	  svg.append("g")
		  .attr("class", "axis--y")
		  //.attr("transform", "translate(" + width + ",0)")
		  .call(yAxis)
		.append("text")
		  .attr("class", "text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 3)
		  .attr("dy", "0.2em")
		  .attr("text-anchor", "end");

		svg.selectAll("rectright")
			.data(data).enter()
				.append("rect")
				  .attr("class", "bar")
				  .attr("y", function(d) { return y(d.fname); })
				  .attr("height", y.rangeBand())
				  .attr("width", function(d) { return xR(Math.abs(d.std_deviation / d.avg)); })
				  .attr("x", width/2 + gap/2) //function(d) { return x(d.std_deviation / d.avg); })
				  .on('mouseover', tipR.show)
				  .on('mouseout', tipR.hide)
				  .on("click", function(d) {console.log("event = ", d.fname)})

		svg.selectAll("rectleft")
			.data(data).enter()
				.append("rect")
				  .attr("class", "bar")
				  .attr("y", function(d) { return y(d.fname); })
				  .attr("height", y.rangeBand())
				  .attr("width", function(d) { return (xL(0) - xL(100 * d.count / docnum)); })
				  .attr("x", function(d) { return (width/2-gap/2)-(xL(0) - xL(100 * d.count/docnum));})
				  //function(d) { return x(d.std_deviation / d.avg); })
				  .on('mouseover', tipL.show)
				  .on('mouseout', tipL.hide)
				  .on("click", function(d) {console.log("event = ", d.fname)})


		svg.append("text")
		    .attr("class", "title")
		    .attr("x", (width / 2))
		    .attr("y", 0 - (margin.top / 2))
		    .attr("text-anchor", "middle")
		    .style("font-size", "16px")
			.style("font-weight", "bold")
		    .text("Measurements in DLR Data");

		svg.append("text")
		    .attr("class", "x-label")
		    .attr("text-anchor", "middle")
		    .attr("x", width/2+(width/2-gap)/2)
		    .attr("y", height+40)
		    .text("Coefficient of variation");

		svg.append("text")
		    .attr("class", "x-label")
		    .attr("text-anchor", "middle")
		    .attr("x", (width/2-gap)/2)
		    .attr("y", height+40)
		    .text("Relative requency of variable");

		svg.select("xaxis")
			.style("font-size","15px");

		svg.select("yaxis")
			.style("font-size","15px");
</script>

<button type="button" class="btn border border-dark btn-default float-sm-right" id="data_request_btn">Request Data</button>

<p id="dyn_block"> Start Content</p>
<br>
<br><br><br>
<label for="mission0">Mission Name:</label>
<input type="text", value = "", id="mission0", class="form-control float-sm-right col-md-6">

<br><br>
<label for="starttimeMin">Select Starttime</label>
<input type="text" id="starttimeMin" value="1900-01-01", class="form_datetime form-control col-md-4 float-sm-right" />
<input type="text" id="starttimeMax" value="2020-12-24", class="form_datetime form-control col-md-4 float-sm-right" />

<br><br>
<label for="stoptimeMin">Select Stoptime</label>
<input type="text" id="stoptimeMin" value="1900-01-01", class="form_datetime form-control col-md-4 float-sm-right" />
<input type="text" id="stoptimeMax" value="2020-12-31", class="form_datetime form-control col-md-4 float-sm-right" />
<br><br><br>


<label for="laditude">Laditude (use "_" instead of floating point)</label>
<input type="text" id="laditude" value="0_000", class="form_datetime form-control col-md-4 float-sm-right" />
<br><br>
<label for="longitude">Longitude (use "_" instead of floating point)</label>
<input type="text" id="longitude" value="0_000", class="form_datetime form-control col-md-4 float-sm-right" />
<br><br>

<table id="testTable" class="table table-striped">
    <thead>
        <tr class="thead-dark">
            <th>Mission</th>
            <th>Starttime</th>   
            <th>Stoptime</th>
            <th>Coordinates</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>value 1</td>
            <td>value 2</td>
            <td>value 3</td>
            <td>value 4</td>
        </tr>
    </tbody>

</table>


<script type="text/javascript">
     $(function() {    
        $("#data_request_btn").click(function(){
            $("#dyn_block").html("Working");
            $.ajax({
                // it needs to be property:value NOT property=value
                // Post request because we need to send filter values
                // Mock Request works with both POST and GET
                type:'GET',
                url:"/api/filter?mission0=" + $("#mission0").val() 
                            +   "&starttimeMin=" + $("#starttimeMin").val()
                            +   "&starttimeMax=" + $("#starttimeMax").val()
                            +   "&stoptimeMin=" + $("#stoptimeMin").val()
                            +   "&stoptimeMax=" + $("#stoptimeMax").val()
                            +   "&longitude=" + $("#longitude").val()
                            +   "&latitude=" + $("#laditude").val(),
                data:{},
                contentType: 'application/json;charset=UTF-8',
                cache: false,
                success: function (data) {
                    console.log('sucessful answer received!');
                    $("#dyn_block").html(data.content);
                    $("#testTable tbody").empty();
                    $.each(data.hits.hits, function(i,item){
                        $("#testTable tbody").append(
                            "<tr>"
                                + "<td>" + data.hits.hits[i]._source.mission0 + "</td>"
                                + "<td>" + data.hits.hits[i]._source.starttime1 + "</td>"
                                + "<td>" + data.hits.hits[i]._source.stoptime1 + "</td>"
                                + "<td>" + data.hits.hits[i]._source.coordinates + "</td>"
                            + "</tr>"
                        );
                    });
                },
            });
        });
    });



</script>
<div class="col-md-12">{{ script|safe }}</div>

{% endblock %}
